<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>–†–∞–¥–æ—Å—Ç—å –≤—Å—Ç—Ä–µ—á —É –≤–æ–¥–æ–µ–º–∞</title>
<style>
    :root {
        --primary-color: #34A853;
        --primary-dark: #2E8B45;
        --primary-light: #e6f4ea;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #6c757d;
        --text-color: #212529;
        --background-color: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --checked-color: #8a929a;
        --danger-color: #dc3545;
        --danger-light: #f8d7da;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--light-gray);
        color: var(--text-color);
        margin: 0;
        padding: 15px;
        -webkit-tap-highlight-color: transparent;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: var(--background-color);
        border-radius: 20px;
        box-shadow: 0 8px 30px var(--shadow-color);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: 20px 25px;
        text-align: center;
        position: relative;
    }

    .header h1 {
        margin: 0;
        font-size: 1.6em;
        font-weight: 600;
        padding: 5px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }
    .header h1[contenteditable="true"]:focus {
        background-color: rgba(255, 255, 255, 0.2);
        outline: none;
    }

    .progress-section {
        padding: 15px 25px;
        background-color: #fafafa;
    }

    .progress-text {
        font-size: 0.9em;
        font-weight: 500;
        color: var(--dark-gray);
        margin-bottom: 8px;
        text-align: center;
    }

    .progress-container {
        background-color: var(--medium-gray);
        border-radius: 10px;
        height: 12px;
        overflow: hidden;
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
    }

    .category {
        border-bottom: 1px solid var(--medium-gray);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .category-title {
        background-color: var(--background-color);
        padding: 15px 20px;
        font-size: 1.2em;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 5;
    }
    
    .category-name {
        flex-grow: 1;
    }

    .category-controls, .item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    .icon-btn:hover {
        background-color: var(--medium-gray);
    }
    .icon-btn svg {
        width: 18px;
        height: 18px;
        stroke-width: 2;
        color: var(--dark-gray);
    }

    .category-title .arrow {
        transition: transform 0.3s;
        font-size: 1em;
        margin-left: 10px;
    }

    .category-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    li {
        display: flex;
        align-items: center;
        padding: 12px 25px 12px 20px;
        border-top: 1px solid var(--light-gray);
        transition: background-color 0.2s, opacity 0.4s ease, transform 0.4s ease;
    }

    li.checked {
        background-color: var(--light-gray);
    }
    
    li.checked .item-details {
       text-decoration: line-through;
       color: var(--checked-color);
    }
    
    li.checked .emoji {
        transform: scale(0.9);
        opacity: 0.5;
    }

    .item-main {
        display: flex;
        align-items: center;
        flex-grow: 1;
        cursor: pointer;
    }

    .emoji {
        font-size: 1.6em;
        margin-right: 18px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        min-width: 30px;
        text-align: center;
    }

    .item-details {
        flex-grow: 1;
        transition: color 0.3s;
    }

    .item-name {
        font-size: 1.05em;
        font-weight: 500;
    }

    .item-note {
        font-size: 0.85em;
        color: #888;
    }
    
    li.checked .item-note {
        color: #aaa;
    }

    .item-quantity {
        font-size: 0.9em;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 8px;
        background-color: var(--medium-gray);
        text-align: center;
        margin-left: 10px;
        color: var(--dark-gray);
    }

    .add-item-btn {
        display: block;
        width: calc(100% - 40px);
        margin: 5px 20px 15px 20px;
        padding: 10px;
        border: 2px dashed var(--medium-gray);
        border-radius: 12px;
        background-color: var(--light-gray);
        color: var(--dark-gray);
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .add-item-btn:hover {
        background-color: var(--medium-gray);
        border-color: #ccc;
    }
    
    .add-category-section {
        padding: 15px 25px;
    }
    .add-category-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background-color: var(--primary-light);
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-size: 1em;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
    }
     .add-category-btn:hover {
        background-color: var(--primary-color);
        color: white;
     }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: var(--background-color);
        padding: 25px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }

    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text-color);
    }

    .modal-form-group {
        margin-bottom: 15px;
    }
    .modal-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.9em;
        color: var(--dark-gray);
    }
    .modal-form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
    }
    .modal-form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px var(--primary-light);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .modal-btn-primary {
        background-color: var(--primary-color);
        color: white;
    }
    .modal-btn-primary:hover {
        background-color: var(--primary-dark);
    }
    .modal-btn-secondary {
        background-color: var(--medium-gray);
        color: var(--text-color);
    }
    .modal-btn-secondary:hover {
        background-color: #d3d9df;
    }

    /* Animation for item removal */
    .removing {
        opacity: 0;
        transform: translateX(-100px);
    }

</style>
</head>
<body>

<div id="app-container">
    <!-- App will be rendered here -->
</div>

<!-- Modal for adding/editing items -->
<div id="item-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="item-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
        <form id="item-modal-form">
            <input type="hidden" id="item-modal-categoryId">
            <input type="hidden" id="item-modal-itemId">
            <div class="modal-form-group">
                <label for="item-name">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input type="text" id="item-name" required>
            </div>
            <div class="modal-form-group">
                <label for="item-emoji">–≠–º–æ–¥–∑–∏</label>
                <input type="text" id="item-emoji">
            </div>
             <div class="modal-form-group">
                <label for="item-note">–ó–∞–º–µ—Ç–∫–∞</label>
                <input type="text" id="item-note">
            </div>
             <div class="modal-form-group">
                <label for="item-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="text" id="item-quantity">
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" id="item-modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="modal-btn modal-btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for adding/editing categories -->
<div id="category-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="category-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
        <form id="category-modal-form">
            <input type="hidden" id="category-modal-id">
            <div class="modal-form-group">
                <label for="category-name-input">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *</label>
                <input type="text" id="category-name-input" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" id="category-modal-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="modal-btn modal-btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const appContainer = document.getElementById('app-container');
    
    // Item Modal
    const itemModal = document.getElementById('item-modal');
    const itemModalForm = document.getElementById('item-modal-form');
    
    // Category Modal
    const categoryModal = document.getElementById('category-modal');
    const categoryModalForm = document.getElementById('category-modal-form');
    
    const STORAGE_KEY = 'picnicListStateV2';

    // --- DEFAULT STATE ---
    const getDefaultState = () => ({
        appName: 'üé£ –†–∞–¥–æ—Å—Ç—å –≤—Å—Ç—Ä–µ—á —É –≤–æ–¥–æ–µ–º–∞',
        categories: [
            {
                id: 'cat-1',
                name: 'ü•© –û—Å–Ω–æ–≤–Ω–æ–µ –¥–ª—è –≥—Ä–∏–ª—è',
                isOpen: true,
                items: [
                    { id: 'item-1', name: '–°–≤–∏–Ω–æ–π –æ—à–µ–µ–∫', note: '–ë–µ–∑ –∫–æ—Å—Ç–∏, –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–π', emoji: 'üçñ', quantity: '3 –∫–≥', checked: false },
                    { id: 'item-2', name: '–°–∫—É–º–±—Ä–∏—è', note: '–î–ª—è –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Ü–∞', emoji: 'üêü', quantity: '2 —à—Ç.', checked: false },
                    { id: 'item-3', name: '–ü—Ä–∏–ø—Ä–∞–≤–∞ –¥–ª—è —à–∞—à–ª—ã–∫–∞', note: '', emoji: 'üå∂Ô∏è', quantity: '1 –ø–∞—á–∫–∞', checked: false },
                    { id: 'item-4', name: '–ü—Ä–∏–ø—Ä–∞–≤–∞ –¥–ª—è —Ä—ã–±—ã', note: '', emoji: 'üåø', quantity: '1 –ø–∞—á–∫–∞', checked: false }
                ]
            },
            {
                id: 'cat-2',
                name: 'ü•¨ –û–≤–æ—â–∏ –∏ –∑–∞–∫—É—Å–∫–∏',
                isOpen: false,
                items: [
                    { id: 'item-5', name: '–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π', note: '–î–ª—è –º–∞—Ä–∏–Ω–∞–¥–∞ –∏ —Å–∞–ª–∞—Ç–∞', emoji: 'üßÖ', quantity: '1 –∫–≥', checked: false },
                    { id: 'item-6', name: '–ü–æ–º–∏–¥–æ—Ä—ã', note: '', emoji: 'üçÖ', quantity: '1.5 –∫–≥', checked: false },
                    { id: 'item-7', name: '–û–≥—É—Ä—Ü—ã', note: '', emoji: 'ü•í', quantity: '1 –∫–≥', checked: false },
                    { id: 'item-8', name: '–ë–æ–ª–≥–∞—Ä—Å–∫–∏–π –ø–µ—Ä–µ—Ü', note: '', emoji: 'ü´ë', quantity: '0.5 –∫–≥', checked: false },
                    { id: 'item-9', name: '–®–∞–º–ø–∏–Ω—å–æ–Ω—ã', note: '–î–ª—è –≥—Ä–∏–ª—è', emoji: 'üçÑ', quantity: '1 –∫–≥', checked: false },
                    { id: 'item-10', name: '–°–æ—É—Å –°–∞—Ü–µ–±–µ–ª–∏', note: '–ö –º—è—Å—É', emoji: 'ü•´', quantity: '1 —à—Ç.', checked: false },
                    { id: 'item-11', name: '–ö–æ—Ä–Ω–∏—à–æ–Ω—ã', note: '–ò–ª–∏ –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–≥—É—Ä—Ü—ã', emoji: 'ü´ô', quantity: '1 –±–∞–Ω–∫–∞', checked: false },
                    { id: 'item-12', name: '–õ–∞–≤–∞—à —Ç–æ–Ω–∫–∏–π', note: '', emoji: 'ü´ì', quantity: '3 —É–ø.', checked: false },
                    { id: 'item-13', name: '–°—ã—Ä —Å—É–ª—É–≥—É–Ω–∏', note: '–î–ª—è –ª–∞–≤–∞—à–∞ –Ω–∞ –º–∞–Ω–≥–∞–ª–µ', emoji: 'üßÄ', quantity: '400 –≥', checked: false },
                    { id: 'item-14', name: '–ó–µ–ª–µ–Ω—å (–∞—Å—Å–æ—Ä—Ç–∏)', note: '', emoji: 'üåø', quantity: '3 –ø—É—á–∫–∞', checked: false }
                ]
            },
            {
                id: 'cat-3',
                name: 'üçπ –ù–∞–ø–∏—Ç–∫–∏',
                isOpen: false,
                items: [
                    { id: 'item-15', name: '–í–æ–¥–∞ –ø–∏—Ç—å–µ–≤–∞—è', note: '', emoji: 'üíß', quantity: '2 –ª', checked: false },
                    { id: 'item-16', name: '–ö–æ–ª–∞ / –õ–∏–º–æ–Ω–∞–¥', note: '', emoji: 'ü•§', quantity: '4 –ª', checked: false },
                    { id: 'item-17', name: '–õ–∏–º–æ–Ω', note: '–î–ª—è —Ä—ã–±—ã –∏ –Ω–∞–ø–∏—Ç–∫–æ–≤', emoji: 'üçã', quantity: '2 —à—Ç.', checked: false },
                    { id: 'item-18', name: '–ü–∏–≤–æ', note: '', emoji: 'üç∫', quantity: '16 –±–∞–Ω–æ–∫', checked: false },
                    { id: 'item-19', name: '–í–∏—Å–∫–∏ (–î–∂–µ–∫ –§–∞–µ—Ä)', note: '', emoji: 'ü•É', quantity: '0.7 –ª', checked: false },
                    { id: 'item-20', name: '–î–∂–∏–Ω (Gordon\'s Pink)', note: '', emoji: 'üç∏', quantity: '0.7 –ª', checked: false },
                    { id: 'item-21', name: '–¢–æ–Ω–∏–∫ / –®–≤–µ–ø—Å', note: '–î–ª—è –¥–∂–∏–Ω–∞', emoji: 'üçπ', quantity: '2 –ª', checked: false }
                ]
            },
            {
                id: 'cat-4',
                name: 'üõ†Ô∏è –ü—Ä–æ—á–µ–µ',
                isOpen: false,
                items: [
                    { id: 'item-22', name: '–£–≥–æ–ª—å', note: '', emoji: 'üî•', quantity: '5 –∫–≥', checked: false },
                    { id: 'item-23', name: '–†–æ–∑–∂–∏–≥', note: '', emoji: 'üíß', quantity: '1 –±—É—Ç.', checked: false },
                    { id: 'item-24', name: '–í–µ–µ—Ä –∏–ª–∏ –∫–∞—Ä—Ç–æ–Ω–∫–∞', note: '–†–∞–∑–¥—É–≤–∞—Ç—å —É–≥–ª–∏', emoji: 'üí®', quantity: '1 —à—Ç.', checked: false },
                    { id: 'item-25', name: '–§–æ–ª—å–≥–∞ –¥–ª—è –∑–∞–ø–µ–∫–∞–Ω–∏—è', note: '', emoji: 'üõ°Ô∏è', quantity: '1 —Ä—É–ª–æ–Ω', checked: false },
                    { id: 'item-26', name: '–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –ø–æ—Å—É–¥–∞', note: '', emoji: 'üç¥', quantity: '1 –∫–æ–º–ø.', checked: false },
                    { id: 'item-27', name: '–°–∞–ª—Ñ–µ—Ç–∫–∏ (—Å—É—Ö/–≤–ª)', note: '', emoji: 'üßª', quantity: '2 —É–ø.', checked: false },
                    { id: 'item-28', name: '–ú—É—Å–æ—Ä–Ω—ã–µ –ø–∞–∫–µ—Ç—ã', note: '', emoji: 'üóëÔ∏è', quantity: '1 —Ä—É–ª–æ–Ω', checked: false },
                    { id: 'item-29', name: '–ù–æ–∂ –∏ –¥–æ—Å–∫–∞', note: '', emoji: 'üî™', quantity: '1 –∫–æ–º–ø.', checked: false }
                ]
            }
        ]
    });
    
    // --- STATE MANAGEMENT ---
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || getDefaultState();

    const saveState = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    // --- RENDER FUNCTION ---
    const render = () => {
        const totalItems = state.categories.reduce((acc, cat) => acc + cat.items.length, 0);
        const checkedItems = state.categories.reduce((acc, cat) => acc + cat.items.filter(i => i.checked).length, 0);
        const percentage = totalItems > 0 ? (checkedItems / totalItems) * 100 : 0;

        appContainer.innerHTML = `
            <div class="container">
                <div class="header">
                    <h1 contenteditable="true" id="app-name">${state.appName}</h1>
                </div>
                
                <div class="progress-section">
                    <div class="progress-text">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${checkedItems} –∏–∑ ${totalItems}</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                </div>

                <div id="categories-container">
                    ${state.categories.map(category => `
                        <div class="category" data-category-id="${category.id}">
                            <div class="category-title">
                                <span class="category-name">${category.name}</span>
                                <div class="category-controls">
                                    <button class="icon-btn edit-category-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                    </button>
                                     <button class="icon-btn delete-category-btn" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                    <span class="arrow">${category.isOpen ? '‚ñ≤' : '‚ñº'}</span>
                                </div>
                            </div>
                            <div class="category-content" style="max-height: ${category.isOpen ? '1500px' : '0'};">
                                <ul>
                                    ${category.items.map(item => `
                                        <li data-item-id="${item.id}" class="${item.checked ? 'checked' : ''}">
                                            <div class="item-main">
                                                <span class="emoji">${item.emoji || 'üõí'}</span>
                                                <div class="item-details">
                                                    <div class="item-name">${item.name}</div>
                                                    ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
                                                </div>
                                            </div>
                                            <div class="item-controls">
                                                ${item.quantity ? `<div class="item-quantity">${item.quantity}</div>` : ''}
                                                <button class="icon-btn edit-item-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                                </button>
                                                 <button class="icon-btn delete-item-btn" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                                <button class="add-item-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="add-category-section">
                    <button class="add-category-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                </div>
            </div>
        `;
        addEventListeners();
    };
    
    // --- EVENT LISTENERS ---
    const addEventListeners = () => {
        // App Name
        document.getElementById('app-name').addEventListener('blur', (e) => {
            state.appName = e.target.innerText;
            saveState();
        });

        // Category toggling
        document.querySelectorAll('.category-title').forEach(title => {
            title.addEventListener('click', (e) => {
                if (e.target.closest('.icon-btn')) return;
                const categoryId = title.parentElement.dataset.categoryId;
                const category = state.categories.find(c => c.id === categoryId);
                category.isOpen = !category.isOpen;
                render();
            });
        });
        
        // Item checking
        document.querySelectorAll('.item-main').forEach(itemEl => {
            itemEl.addEventListener('click', () => {
                const itemId = itemEl.parentElement.dataset.itemId;
                for (const category of state.categories) {
                    const item = category.items.find(i => i.id === itemId);
                    if (item) {
                        item.checked = !item.checked;
                        break;
                    }
                }
                saveState();
                render();
            });
        });

        // Add Category
        document.querySelector('.add-category-btn').addEventListener('click', () => {
            openCategoryModal();
        });

        // Edit Category
        document.querySelectorAll('.edit-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('.category').dataset.categoryId;
                openCategoryModal(categoryId);
            });
        });

        // Delete Category
        document.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('.category').dataset.categoryId;
                const category = state.categories.find(c => c.id === categoryId);
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}" –∏ –≤—Å–µ –µ–µ –ø—Ä–æ–¥—É–∫—Ç—ã?`)) {
                    state.categories = state.categories.filter(c => c.id !== categoryId);
                    saveState();
                    render();
                }
            });
        });
        
        // Add Item
        document.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('.category').dataset.categoryId;
                openItemModal(categoryId);
            });
        });

        // Edit Item
        document.querySelectorAll('.edit-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('.category').dataset.categoryId;
                const itemId = e.target.closest('li').dataset.itemId;
                openItemModal(categoryId, itemId);
            });
        });

        // Delete Item
        document.querySelectorAll('.delete-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                const itemId = li.dataset.itemId;
                const categoryId = e.target.closest('.category').dataset.categoryId;
                
                const category = state.categories.find(c => c.id === categoryId);
                if(category) {
                    const item = category.items.find(i => i.id === itemId);
                    if (item && confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç "${item.name}"?`)) {
                        li.classList.add('removing');
                        setTimeout(() => {
                            category.items = category.items.filter(i => i.id !== itemId);
                            saveState();
                            render();
                        }, 400);
                    }
                }
            });
        });
    };

    // --- ITEM MODAL LOGIC ---
    const openItemModal = (categoryId, itemId = null) => {
        itemModalForm.reset();
        document.getElementById('item-modal-categoryId').value = categoryId;
        
        if (itemId) {
            document.getElementById('item-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
            const category = state.categories.find(c => c.id === categoryId);
            const item = category.items.find(i => i.id === itemId);
            document.getElementById('item-modal-itemId').value = itemId;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-emoji').value = item.emoji || '';
            document.getElementById('item-note').value = item.note || '';
            document.getElementById('item-quantity').value = item.quantity || '';
        } else {
            document.getElementById('item-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç';
            document.getElementById('item-modal-itemId').value = '';
        }
        itemModal.classList.add('visible');
    };

    const closeItemModal = () => itemModal.classList.remove('visible');

    itemModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const categoryId = document.getElementById('item-modal-categoryId').value;
        const itemId = document.getElementById('item-modal-itemId').value;
        const category = state.categories.find(c => c.id === categoryId);
        
        const itemData = {
            name: document.getElementById('item-name').value.trim(),
            emoji: document.getElementById('item-emoji').value.trim(),
            note: document.getElementById('item-note').value.trim(),
            quantity: document.getElementById('item-quantity').value.trim(),
        };

        if (!itemData.name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');

        if (itemId) {
            const item = category.items.find(i => i.id === itemId);
            Object.assign(item, itemData);
        } else {
            category.items.push({ ...itemData, id: `item-${Date.now()}`, checked: false });
        }
        
        saveState();
        render();
        closeItemModal();
    });

    // --- CATEGORY MODAL LOGIC ---
    const openCategoryModal = (categoryId = null) => {
        categoryModalForm.reset();
        if (categoryId) {
            document.getElementById('category-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            const category = state.categories.find(c => c.id === categoryId);
            document.getElementById('category-modal-id').value = categoryId;
            document.getElementById('category-name-input').value = category.name;
        } else {
            document.getElementById('category-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            document.getElementById('category-modal-id').value = '';
        }
        categoryModal.classList.add('visible');
    };

    const closeCategoryModal = () => categoryModal.classList.remove('visible');

    categoryModalForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const categoryId = document.getElementById('category-modal-id').value;
        const categoryName = document.getElementById('category-name-input').value.trim();

        if (!categoryName) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');

        if (categoryId) {
            const category = state.categories.find(c => c.id === categoryId);
            category.name = categoryName;
        } else {
            state.categories.push({
                id: `cat-${Date.now()}`,
                name: categoryName,
                isOpen: true,
                items: []
            });
        }
        saveState();
        render();
        closeCategoryModal();
    });

    // --- GENERAL MODAL CLOSING ---
    document.getElementById('item-modal-cancel').addEventListener('click', closeItemModal);
    itemModal.addEventListener('click', (e) => e.target === itemModal && closeItemModal());
    
    document.getElementById('category-modal-cancel').addEventListener('click', closeCategoryModal);
    categoryModal.addEventListener('click', (e) => e.target === categoryModal && closeCategoryModal());

    // --- INITIAL RENDER ---
    render();
});
</script>

</body>
</html>
